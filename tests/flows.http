@base = https://localhost:7086
@json = application/json
@name = {{$guid}}
@email = test-{{$timestamp}}@example.com
@password = StrongP@ssw0rd!X

### Ping (sanity)
GET {{base}}/api/ping

### Register
# @name register
POST {{base}}/api/v1/authenticate/register
Content-Type: {{json}}

{
  "username": "user-{{name}}",
  "email": "{{email}}",
  "password": "{{password}}"
}

> {% 
client.test('register ok', () => {
  client.assert(response.status === 200 || response.status === 400, 'unexpected status ' + response.status);
});
%}

### Request Email Confirm
# @name reqConfirm
POST {{base}}/api/v1/authenticate/request-email-confirm
Content-Type: {{json}}

{
  "email": "{{email}}"
}

### Confirm Email (paste token then send)
# @prompt confirm_token Enter email confirmation token
# @name confirmEmail
POST {{base}}/api/v1/authenticate/confirm-email
Content-Type: {{json}}

{
  "email": "{{email}}",
  "token": "{{confirm_token}}"
}

### Login
# @name login
POST {{base}}/api/v1/authenticate/login
Content-Type: {{json}}
X-Login-Id: {{email}}

{
  "identifier": "{{email}}",
  "password": "{{password}}"
}

> {% 
client.test('login ok or mfa required', () => {
  client.assert(response.status === 200, 'login not 200');
});
if (response.body && response.body.token) {
  client.global.set('accessToken', response.body.token);
  client.global.set('refreshToken', response.body.refreshToken);
}
%}

### Me
GET {{base}}/api/v1/users/me
Authorization: Bearer {{accessToken}}

### Refresh
# @name refresh
POST {{base}}/api/v1/authenticate/refresh
Content-Type: {{json}}

{
  "refreshToken": "{{refreshToken}}"
}

> {% 
if (response.body && response.body.token) {
  client.global.set('accessToken', response.body.token);
  client.global.set('refreshToken', response.body.refreshToken);
}
%}

### MFA Enroll Start
# @name mfaStart
POST {{base}}/api/v1/authenticate/mfa/enroll/start
Authorization: Bearer {{accessToken}}

> {% 
if (response.body && response.body.otpauthUrl) {
  client.global.set('otpauthUrl', response.body.otpauthUrl);
}
%}

### MFA Enroll Confirm (paste current 6-digit code)
# @prompt mfa_code Enter current 6-digit TOTP code
POST {{base}}/api/v1/authenticate/mfa/enroll/confirm
Authorization: Bearer {{accessToken}}
Content-Type: {{json}}

{
  "code": "{{mfa_code}}"
}

### Request Password Reset
POST {{base}}/api/v1/authenticate/request-password-reset
Content-Type: {{json}}

{
  "email": "{{email}}"
}

### Confirm Password Reset (paste reset token)
# @prompt reset_token Enter password reset token
POST {{base}}/api/v1/authenticate/confirm-password-reset
Content-Type: {{json}}

{
  "email": "{{email}}",
  "token": "{{reset_token}}",
  "newPassword": "StrongP@ssw0rd!!X"
}

